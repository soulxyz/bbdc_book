name: Build and Package

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executables with PyInstaller
      run: |
        # æ‰“åŒ…ä¸»ç¨‹åº
        pyinstaller --onefile --windowed --name="ä¸èƒŒå•è¯å•è¯æœ¬åˆ¶ä½œ" --icon=NONE `
          --add-data "README.md;." `
          --hidden-import=bs4 `
          --hidden-import=lxml `
          --hidden-import=requests `
          extract_words.py
        
        # æ‰“åŒ… Mineru API å·¥å…·
        pyinstaller --onefile --console --name="Mineru-PDFå¤„ç†" --icon=NONE `
          --hidden-import=bs4 `
          --hidden-import=lxml `
          --hidden-import=requests `
          mineru_api.py
        
        # æ‰“åŒ…ä¸èƒŒå•è¯æ ¸å¯¹å·¥å…·
        pyinstaller --onefile --console --name="ä¸èƒŒå•è¯æ ¸å¯¹" --icon=NONE `
          --hidden-import=requests `
          bbdc_word_checker.py
    
    - name: Copy additional files
      run: |
        # å¤åˆ¶åˆ° dist ç›®å½•
        Copy-Item "README.md" -Destination "dist/"
        Copy-Item "requirements.txt" -Destination "dist/"
        Copy-Item "*.bat" -Destination "dist/"
        
        # åˆ›å»ºç¤ºä¾‹ .env æ–‡ä»¶
        @"
        # Mineru API Token
        MINERU_API_TOKEN=your_token_here
        
        # SiliconFlow API Key (å¯é€‰)
        SILICONFLOW_API_KEY=
        "@ | Out-File -FilePath "dist/.env.example" -Encoding UTF8
    
    - name: Create release package
      run: |
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        @"
        ä¸èƒŒå•è¯å•è¯æœ¬åˆ¶ä½œå·¥å…·
        
        æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        æäº¤: ${{ github.sha }}
        åˆ†æ”¯: ${{ github.ref_name }}
        
        ä½¿ç”¨æ–¹æ³•ï¼š
        1. é…ç½® .env æ–‡ä»¶ï¼ˆå‚è€ƒ .env.exampleï¼‰
        2. åŒå‡»è¿è¡Œ .bat æ‰¹å¤„ç†æ–‡ä»¶
        3. æˆ–ç›´æ¥è¿è¡Œ exe å¯æ‰§è¡Œæ–‡ä»¶
        
        é¡¹ç›®åœ°å€: ${{ github.repository }}
        "@ | Out-File -FilePath "dist/VERSION.txt" -Encoding UTF8
        
        # å‹ç¼©æ‰“åŒ…
        Compress-Archive -Path "dist/*" -DestinationPath "bbdc_word_tool_windows.zip"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: windows-executables
        path: bbdc_word_tool_windows.zip
        retention-days: 30
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: bbdc_word_tool_windows.zip
        body: |
          ## ä¸èƒŒå•è¯å•è¯æœ¬åˆ¶ä½œå·¥å…· ${{ github.ref_name }}
          
          ### ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          
          ### ğŸ“¦ åŒ…å«æ–‡ä»¶
          - ä¸èƒŒå•è¯å•è¯æœ¬åˆ¶ä½œ.exe - ä¸»ç¨‹åºï¼ˆæ”¯æŒ PDF å’Œ Markdownï¼‰
          - Mineru-PDFå¤„ç†.exe - Mineru API ç‹¬ç«‹å·¥å…·
          - ä¸èƒŒå•è¯æ ¸å¯¹.exe - ä¸èƒŒå•è¯æ ¸å¯¹å·¥å…·
          - æ‰¹å¤„ç†æ–‡ä»¶ (.bat)
          - é…ç½®æ–‡ä»¶ç¤ºä¾‹ (.env.example)
          - è¯´æ˜æ–‡æ¡£
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¹¶è§£å‹ `bbdc_word_tool_windows.zip`
          2. å°† `.env.example` é‡å‘½åä¸º `.env` å¹¶é…ç½® API Token
          3. åŒå‡»æ‰¹å¤„ç†æ–‡ä»¶æˆ–ç›´æ¥è¿è¡Œ exe
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          è¯¦è§æäº¤è®°å½•
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - Mineru API: https://mineru.net/
          - ä¸èƒŒå•è¯: https://bbdc.cn/
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

