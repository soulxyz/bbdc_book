name: Build and Package

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executables with PyInstaller
      run: |
        # æ‰“åŒ…ä¸»ç¨‹åºï¼ˆå¸¦æ§åˆ¶å°ï¼‰
        pyinstaller --onefile --console --name="ä¸èƒŒå•è¯å•è¯æœ¬åˆ¶ä½œ" `
          --hidden-import=bs4 `
          --hidden-import=lxml `
          --hidden-import=requests `
          extract_words.py
    
    - name: Copy additional files
      run: |
        # å¤åˆ¶åˆ° dist ç›®å½•
        Copy-Item "README.md" -Destination "dist/"
        Copy-Item "requirements.txt" -Destination "dist/"
        Copy-Item "*.bat" -Destination "dist/"
        
        # åˆ›å»ºç¤ºä¾‹ .env æ–‡ä»¶
        @"
        # Mineru API Token ï¼ˆå¿…é¡»é…ç½®æ‰èƒ½å¤„ç† PDF æ–‡ä»¶ï¼‰
        # è·å–åœ°å€ï¼šhttps://mineru.net/
        MINERU_API_TOKEN=your_token_here
        
        # SiliconFlow API Key ï¼ˆå¯é€‰ï¼Œç”¨äº AI è‡ªåŠ¨æ›´æ­£åŠŸèƒ½ï¼‰
        # è·å–åœ°å€ï¼šhttps://cloud.siliconflow.cn/
        SILICONFLOW_API_KEY=
        "@ | Out-File -FilePath "dist/.env.example" -Encoding UTF8
    
    - name: Create release package
      run: |
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        @"
        ä¸èƒŒå•è¯å•è¯æœ¬åˆ¶ä½œå·¥å…·
        
        æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        æäº¤: ${{ github.sha }}
        åˆ†æ”¯: ${{ github.ref_name }}
        
        ============================================
        ğŸ“– å¿«é€Ÿå¼€å§‹
        ============================================
        
        1. é…ç½® .env æ–‡ä»¶ï¼ˆå¤„ç† PDF å¿…é¡»ï¼‰
           - å°† .env.example é‡å‘½åä¸º .env
           - åœ¨ .env æ–‡ä»¶ä¸­å¡«å…¥ä½ çš„ Mineru API Token
           - âš ï¸ .env æ–‡ä»¶å¿…é¡»ä¸ exe æ”¾åœ¨åŒä¸€ç›®å½•ä¸‹ï¼
           
        2. è¿è¡Œç¨‹åº
           æ–¹å¼1ï¼šåŒå‡» è¿è¡Œ.bat æˆ– è¿è¡Œå¿«é€Ÿç‰ˆ.bat
           æ–¹å¼2ï¼šç›´æ¥åŒå‡» ä¸èƒŒå•è¯å•è¯æœ¬åˆ¶ä½œ.exe
           
        3. æ‹–å…¥æ–‡ä»¶
           - æ”¯æŒ PDF æ–‡ä»¶ï¼ˆéœ€è¦é…ç½® .envï¼‰
           - æ”¯æŒ Markdown æ–‡ä»¶ï¼ˆ.mdï¼‰
        
        ============================================
        ğŸ“ æ–‡ä»¶ç»“æ„ï¼ˆé‡è¦ï¼ï¼‰
        ============================================
        
        ä½ çš„æ–‡ä»¶å¤¹/
        â”œâ”€â”€ ä¸èƒŒå•è¯å•è¯æœ¬åˆ¶ä½œ.exe
        â”œâ”€â”€ .env                    â† é…ç½®æ–‡ä»¶å¿…é¡»åœ¨è¿™é‡Œï¼
        â”œâ”€â”€ è¿è¡Œ.bat
        â””â”€â”€ ...
        
        ============================================
        ğŸ”— ç›¸å…³é“¾æ¥
        ============================================
        
        é¡¹ç›®åœ°å€: https://github.com/${{ github.repository }}
        Mineru API: https://mineru.net/
        ä¸èƒŒå•è¯: https://bbdc.cn/
        "@ | Out-File -FilePath "dist/VERSION.txt" -Encoding UTF8
        
        # å‹ç¼©æ‰“åŒ…
        Compress-Archive -Path "dist/*" -DestinationPath "bbdc_word_tool_windows.zip"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-executables
        path: bbdc_word_tool_windows.zip
        retention-days: 30
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: bbdc_word_tool_windows.zip
        body: |
          ## ä¸èƒŒå•è¯å•è¯æœ¬åˆ¶ä½œå·¥å…· ${{ github.ref_name }}
          
          ### ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          
          ### ğŸ“¦ åŒ…å«æ–‡ä»¶
          - ä¸èƒŒå•è¯å•è¯æœ¬åˆ¶ä½œ.exe - ä¸»ç¨‹åºï¼ˆæ”¯æŒ PDF å’Œ Markdown æ–‡ä»¶å¤„ç†ï¼‰
          - æ‰¹å¤„ç†æ–‡ä»¶ (.bat) - å¿«é€Ÿå¯åŠ¨è„šæœ¬
          - é…ç½®æ–‡ä»¶ç¤ºä¾‹ (.env.example) - API Token é…ç½®æ¨¡æ¿
          - README.md - ä½¿ç”¨è¯´æ˜æ–‡æ¡£
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¹¶è§£å‹ `bbdc_word_tool_windows.zip`
          2. å°† `.env.example` é‡å‘½åä¸º `.env` å¹¶é…ç½® API Token
          3. åŒå‡»æ‰¹å¤„ç†æ–‡ä»¶æˆ–ç›´æ¥è¿è¡Œ exe
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          è¯¦è§æäº¤è®°å½•
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - Mineru API: https://mineru.net/
          - ä¸èƒŒå•è¯: https://bbdc.cn/
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

