name: Build and Package

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ‰èƒ½åˆ›å»º Release

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executables with PyInstaller
      run: |
        # æ‰“åŒ…ä¸»ç¨‹åºï¼ˆå¸¦æ§åˆ¶å°ï¼Œä½¿ç”¨è‹±æ–‡åï¼‰
        pyinstaller --onefile --console --name=bbdc_word_tool `
          --hidden-import=bs4 `
          --hidden-import=lxml `
          --hidden-import=requests `
          --hidden-import=tqdm `
          --hidden-import=env_loader `
          --collect-all tqdm `
          extract_words.py
    
    - name: Create .env.example
      run: |
        # åˆ›å»ºç¤ºä¾‹ .env æ–‡ä»¶
        @"
        # Mineru API Token ï¼ˆå¿…é¡»é…ç½®æ‰èƒ½å¤„ç† PDF æ–‡ä»¶ï¼‰
        # è·å–åœ°å€ï¼šhttps://mineru.net/
        MINERU_API_TOKEN=your_token_here
        
        # SiliconFlow API Key ï¼ˆå¯é€‰ï¼Œç”¨äº AI è‡ªåŠ¨æ›´æ­£åŠŸèƒ½ï¼‰
        # è·å–åœ°å€ï¼šhttps://cloud.siliconflow.cn/
        SILICONFLOW_API_KEY=
        "@ | Out-File -FilePath "dist/.env.example" -Encoding UTF8
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-executables
        path: |
          dist/bbdc_word_tool.exe
          dist/.env.example
        retention-days: 30
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/bbdc_word_tool.exe
          dist/.env.example
        body: |
          ## ä¸èƒŒå•è¯å•è¯æœ¬åˆ¶ä½œå·¥å…· ${{ github.ref_name }}
          
          ### ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          
          ### ğŸ“¦ ä¸‹è½½æ–‡ä»¶
          
          1. **bbdc_word_tool.exe** - ä¸»ç¨‹åºï¼ˆå¯è‡ªè¡Œé‡å‘½åä¸ºä¸­æ–‡ï¼‰
          2. **.env.example** - é…ç½®æ–‡ä»¶æ¨¡æ¿
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          
          1. **ä¸‹è½½æ–‡ä»¶**
             - ä¸‹è½½ `bbdc_word_tool.exe`ï¼ˆå¯é‡å‘½åä¸ºä¸­æ–‡ï¼‰
             - ä¸‹è½½ `.env.example`ï¼ˆå¤„ç† PDF æ—¶éœ€è¦ï¼‰
          
          2. **é…ç½®ï¼ˆå¤„ç† PDF å¿…é¡»ï¼‰**
             ```
             # å°† .env.example é‡å‘½åä¸º .env
             # ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„ Mineru API Token
             MINERU_API_TOKEN=your_token_here
             ```
             
             âš ï¸ **é‡è¦**ï¼š.env æ–‡ä»¶å¿…é¡»ä¸ exe æ”¾åœ¨åŒä¸€æ–‡ä»¶å¤¹
          
          3. **è¿è¡Œç¨‹åº**
             - åŒå‡» `bbdc_word_tool.exe` è¿è¡Œ
             - æŒ‰æç¤ºæ‹–å…¥ PDF æˆ– Markdown æ–‡ä»¶
             - ğŸ’¡ å¯ä»¥å°† exe é‡å‘½åä¸ºä¸­æ–‡åï¼Œä¸å½±å“ä½¿ç”¨
          
          ### âœ¨ æ”¯æŒçš„åŠŸèƒ½
          
          - ğŸ“„ **PDF æ–‡ä»¶å¤„ç†**ï¼ˆéœ€é…ç½® Mineru API Tokenï¼‰
          - ğŸ“ **Markdown æ–‡ä»¶å¤„ç†**
          - ğŸ” è‡ªåŠ¨æå–å•è¯å¹¶å»é‡
          - âœ… è‡ªåŠ¨æ ¸å¯¹å•è¯ï¼ˆä¸èƒŒå•è¯ APIï¼‰
          - ğŸ¤– AI è‡ªåŠ¨æ›´æ­£é”™è¯¯å•è¯ï¼ˆå¯é€‰ï¼‰
          - ğŸ“Š å®æ—¶è¿›åº¦æ¡æ˜¾ç¤º
          
          ### ğŸ“ æ–‡ä»¶ç»“æ„ç¤ºä¾‹
          
          ```
          ä½ çš„æ–‡ä»¶å¤¹/
          â”œâ”€â”€ bbdc_word_tool.exe      â† ä¸»ç¨‹åºï¼ˆå¯é‡å‘½åä¸ºä¸­æ–‡ï¼‰
          â””â”€â”€ .env                    â† é…ç½®æ–‡ä»¶ï¼ˆå¦‚éœ€å¤„ç† PDFï¼‰
          ```
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          
          - é¡¹ç›®åœ°å€: https://github.com/${{ github.repository }}
          - Mineru API: https://mineru.net/
          - ä¸èƒŒå•è¯: https://bbdc.cn/
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          
          è¯¦è§æäº¤è®°å½•
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

